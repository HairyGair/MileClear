datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  passwordHash     String?
  displayName      String?
  emailVerified    Boolean   @default(false)
  appleId          String?   @unique
  googleId         String?   @unique
  isPremium            Boolean   @default(false)
  isAdmin              Boolean   @default(false)
  premiumExpiresAt     DateTime?
  stripeCustomerId     String?   @unique @db.VarChar(255)
  stripeSubscriptionId String?   @unique @db.VarChar(255)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  vehicles            Vehicle[]
  shifts              Shift[]
  trips               Trip[]
  fuelLogs            FuelLog[]
  earnings            Earning[]
  achievements        Achievement[]
  mileageSummary      MileageSummary[]
  refreshTokens       RefreshToken[]
  verificationCodes   VerificationCode[]
  passwordResetTokens PasswordResetToken[]
  plaidConnections    PlaidConnection[]
  feedback            Feedback[]
  feedbackVotes       FeedbackVote[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Vehicle {
  id                String   @id @default(uuid())
  userId            String
  make              String
  model             String
  year              Int?
  fuelType          String
  vehicleType       String
  registrationPlate String?  @db.VarChar(10)
  estimatedMpg      Float?
  actualMpg         Float?
  isPrimary         Boolean  @default(true)
  createdAt         DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shifts   Shift[]
  trips    Trip[]
  fuelLogs FuelLog[]

  @@map("vehicles")
}

model Shift {
  id        String    @id @default(uuid())
  userId    String
  vehicleId String?
  startedAt DateTime
  endedAt   DateTime?
  status    String    @default("active")
  createdAt DateTime  @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])
  trips   Trip[]

  @@map("shifts")
}

model Trip {
  id             String    @id @default(uuid())
  userId         String
  shiftId        String?
  vehicleId      String?
  startLat       Float
  startLng       Float
  endLat         Float?
  endLng         Float?
  startAddress   String?
  endAddress     String?
  distanceMiles  Float
  startedAt      DateTime
  endedAt        DateTime?
  isManualEntry  Boolean   @default(false)
  classification String    @default("business")
  platformTag    String?
  notes          String?   @db.Text
  routePolyline  String?   @db.LongText
  createdAt      DateTime  @default(now())
  syncedAt       DateTime?

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  shift       Shift?            @relation(fields: [shiftId], references: [id])
  vehicle     Vehicle?          @relation(fields: [vehicleId], references: [id])
  coordinates TripCoordinate[]

  @@index([userId, startedAt])
  @@index([userId, classification])
  @@map("trips")
}

model TripCoordinate {
  id         String   @id @default(uuid())
  tripId     String
  lat        Float
  lng        Float
  speed      Float?
  accuracy   Float?
  recordedAt DateTime

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId, recordedAt])
  @@map("trip_coordinates")
}

model FuelLog {
  id              String   @id @default(uuid())
  userId          String
  vehicleId       String?
  litres          Float
  costPence       Int
  stationName     String?
  odometerReading Float?
  latitude        Float?
  longitude       Float?
  loggedAt        DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([latitude, longitude])
  @@map("fuel_logs")
}

model Earning {
  id          String   @id @default(uuid())
  userId      String
  platform    String
  amountPence Int
  periodStart DateTime @db.Date
  periodEnd   DateTime @db.Date
  source      String
  externalId  String?  @db.VarChar(255)
  notes       String?  @db.Text
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, externalId])
  @@index([userId, periodStart])
  @@map("earnings")
}

model Achievement {
  id         String   @id @default(uuid())
  userId     String
  type       String
  achievedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("achievements")
}

model MileageSummary {
  id             String   @id @default(uuid())
  userId         String
  taxYear        String
  totalMiles     Float    @default(0)
  businessMiles  Float    @default(0)
  deductionPence Int      @default(0)
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taxYear])
  @@map("mileage_summaries")
}

model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  code      String   @db.VarChar(6)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, used])
  @@map("verification_codes")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  code      String   @db.VarChar(6)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, used])
  @@map("password_reset_tokens")
}

model PlaidConnection {
  id              String    @id @default(uuid())
  userId          String
  institutionId   String?
  institutionName String?
  accessToken     String    @db.VarChar(500)
  itemId          String    @unique
  lastSynced      DateTime?
  status          String    @default("active")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("plaid_connections")
}

model Feedback {
  id          String   @id @default(uuid())
  userId      String?
  displayName String?  @db.VarChar(100)
  title       String   @db.VarChar(200)
  body        String   @db.Text
  category    String   @default("feature_request")
  status      String   @default("new")
  upvoteCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  votes FeedbackVote[]

  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("feedback")
}

model FeedbackVote {
  id         String   @id @default(uuid())
  feedbackId String
  userId     String
  createdAt  DateTime @default(now())

  feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([feedbackId, userId])
  @@map("feedback_votes")
}

model WaitlistEntry {
  id         String   @id @default(uuid())
  email      String   @unique
  driverType String?
  signedUpAt DateTime @default(now())

  @@map("waitlist")
}
